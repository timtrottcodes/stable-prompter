<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stable Diffusion Prompt Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .tree-category { cursor: pointer; font-weight: bold; margin-top: 5px; }
    .tree-item { cursor: pointer; margin-left: 20px; display: block; }
    textarea { height: 150px; }
    .slot-btn { margin-right: 5px; margin-top: 5px; }
    #dropZone {
      border: 2px dashed #666;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #f9f9f9;
    }
    #dropZone.dragover {
      background: #e8f5e9;
      border-color: #28a745;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Stable Diffusion Prompt Manager</h1>

  <!-- Main Prompt Areas -->
  <div class="row">
    <div class="col-md-6">
      <h4>Prompt</h4>
      <textarea id="promptBox" class="form-control mb-2"></textarea>
      <div>
        <button class="btn btn-sm btn-secondary" onclick="toLowercase('promptBox')">Lowercase</button>
        <button class="btn btn-sm btn-secondary" onclick="dedupe('promptBox')">De-duplicate</button>
        <button class="btn btn-sm btn-secondary" onclick="formatPrompt('promptBox')">Format</button>
      </div>
    </div>
    <div class="col-md-6">
      <h4>Negative Prompt</h4>
      <textarea id="negPromptBox" class="form-control mb-2"></textarea>
      <div>
        <button class="btn btn-sm btn-secondary" onclick="toLowercase('negPromptBox')">Lowercase</button>
        <button class="btn btn-sm btn-secondary" onclick="dedupe('negPromptBox')">De-duplicate</button>
        <button class="btn btn-sm btn-secondary" onclick="formatPrompt('negPromptBox')">Format</button>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- Slots -->
  <h4>Saved Prompts</h4>
  <div id="slots" class="mb-3"></div>
  <div class="mb-3">
    <button class="btn btn-primary btn-sm" onclick="saveCurrent()">Save Current</button>
    <button class="btn btn-outline-primary btn-sm" onclick="clearSlots()">Clear All</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="exportPrompts()">Export JSON</button>
    <input type="file" id="importFile" style="display:none" accept="application/json" onchange="importPrompts(event)">
    <button class="btn btn-outline-secondary btn-sm" onclick="document.getElementById('importFile').click()">Import JSON</button>
  </div>

  <hr class="my-4">

  <!-- Image Drop Zone -->
  <h4>Import Prompt from Image</h4>
  <div id="dropZone">Drag & drop a PNG here</div>
  <textarea id="imagePromptBox" class="form-control mb-2" placeholder="Imported prompt will appear here..."></textarea>
  <div>
    <button class="btn btn-sm btn-secondary" onclick="toLowercase('imagePromptBox')">Lowercase</button>
    <button class="btn btn-sm btn-secondary" onclick="dedupe('imagePromptBox')">De-duplicate</button>
    <button class="btn btn-sm btn-secondary" onclick="formatPrompt('imagePromptBox')">Format</button>
    <button class="btn btn-sm btn-success" onclick="addSelectionToSnippets()">Add Selection to Snippets</button>
  </div>

  <hr class="my-4">

  <!-- Tree View -->
  <h4>Prompt Builder</h4>
  <input type="text" id="searchBox" class="form-control mb-2" placeholder="Search snippets...">
  <div id="treeView" class="mb-4"></div>
</div>

<script>
  // ====== SAMPLE CATEGORIES ======
  const categories = {
    "Quality": ["high quality", "8k", "masterpiece", "ultra detailed"],
    "Styles": ["photorealistic portrait", "anime style", "cartoon", "oil painting"],
    "Effects": ["cinematic lighting", "soft focus", "hdr", "vivid colors"],
    "Negative": ["low quality", "blurry", "bad anatomy", "duplicate"],
    "Custom": []
  };

  // ====== TEXT AREA HELPERS ======
  function getTokens(id) {
    return document.getElementById(id).value.split(",")
      .map(t => t.trim()).filter(t => t.length > 0);
  }

  function setTokens(id, tokens) {
    document.getElementById(id).value = tokens.join(", ");
  }

  function toLowercase(id) {
    let tokens = getTokens(id).map(t => t.toLowerCase());
    setTokens(id, tokens);
  }

  function dedupe(id) {
    let tokens = [...new Set(getTokens(id).map(t => t.toLowerCase()))];
    setTokens(id, tokens);
  }

  function formatPrompt(id) {
    let tokens = [...new Set(getTokens(id).map(t => t.toLowerCase()))];
    setTokens(id, tokens);
  }

  // ====== TREE VIEW ======
  function buildTree(filter="") {
    const container = document.getElementById("treeView");
    container.innerHTML = "";

    for (let category in categories) {
      let catDiv = document.createElement("div");
      catDiv.className = "tree-category";
      catDiv.innerText = category;
      catDiv.onclick = () => {
        let next = catDiv.nextSibling;
        next.style.display = next.style.display === "none" ? "block" : "none";
      };
      container.appendChild(catDiv);

      let itemDiv = document.createElement("div");
      categories[category].forEach(snippet => {
        if (snippet.toLowerCase().includes(filter.toLowerCase())) {
          let item = document.createElement("span");
          item.className = "tree-item";
          item.innerText = snippet;
          item.onclick = () => insertSnippet(snippet, category);
          itemDiv.appendChild(item);
        }
      });
      container.appendChild(itemDiv);
    }
  }

  function insertSnippet(snippet, category) {
    const boxId = (category === "Negative") ? "negPromptBox" : "promptBox";
    let tokens = getTokens(boxId);
    tokens.push(snippet);
    setTokens(boxId, tokens);
    formatPrompt(boxId);
  }

  // ====== SLOT MANAGEMENT ======
  function loadSlots() {
    const slotsDiv = document.getElementById("slots");
    slotsDiv.innerHTML = "";
    let saved = JSON.parse(localStorage.getItem("sdSlots") || "[]");

    saved.forEach((slot, idx) => {
      let btn = document.createElement("button");
      btn.className = "btn btn-sm btn-outline-dark slot-btn";
      btn.innerText = `Slot ${idx+1}`;
      btn.onclick = () => {
        document.getElementById("promptBox").value = slot.prompt;
        document.getElementById("negPromptBox").value = slot.negative;
      };
      slotsDiv.appendChild(btn);
    });
  }

  function saveCurrent() {
    let saved = JSON.parse(localStorage.getItem("sdSlots") || "[]");
    saved.push({
      prompt: document.getElementById("promptBox").value,
      negative: document.getElementById("negPromptBox").value
    });
    localStorage.setItem("sdSlots", JSON.stringify(saved));
    loadSlots();
  }

  function clearSlots() {
    localStorage.removeItem("sdSlots");
    loadSlots();
  }

  function exportPrompts() {
    let saved = localStorage.getItem("sdSlots") || "[]";
    let blob = new Blob([saved], { type: "application/json" });
    let url = URL.createObjectURL(blob);
    let a = document.createElement("a");
    a.href = url;
    a.download = "prompts.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importPrompts(event) {
    let file = event.target.files[0];
    let reader = new FileReader();
    reader.onload = function(e) {
      try {
        localStorage.setItem("sdSlots", e.target.result);
        loadSlots();
      } catch(err) {
        alert("Invalid JSON file");
      }
    };
    reader.readAsText(file);
  }

  // ====== IMAGE METADATA READER (Robust) ======
  function readPromptFromPNG(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const bytes = new Uint8Array(e.target.result);
      let textChunks = [];

      let i = 8; // skip PNG signature
      while (i < bytes.length) {
        let length = (bytes[i]<<24) | (bytes[i+1]<<16) | (bytes[i+2]<<8) | (bytes[i+3]);
        let type = String.fromCharCode(bytes[i+4], bytes[i+5], bytes[i+6], bytes[i+7]);
        let dataStart = i + 8;
        let dataEnd = dataStart + length;
        let data = bytes.slice(dataStart, dataEnd);

        if (type === "tEXt" || type === "iTXt" || type === "zTXt") {
          let chunkText = new TextDecoder().decode(data);
          if (chunkText.includes("parameters") || chunkText.includes("prompt")) {
            textChunks.push(chunkText);
          }
        }

        i = dataEnd + 4; // skip CRC
      }

      let result = textChunks.join("\n---\n");
      document.getElementById("imagePromptBox").value = result || "No prompt metadata found.";
    };
    reader.readAsArrayBuffer(file);
  }

  // ====== DRAG & DROP ======
  const dropZone = document.getElementById("dropZone");
  dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.classList.add("dragover");
  });
  dropZone.addEventListener("dragleave", () => dropZone.classList.remove("dragover"));
  dropZone.addEventListener("drop", (e) => {
    e.preventDefault();
    dropZone.classList.remove("dragover");
    if (e.dataTransfer.files.length > 0) {
      let file = e.dataTransfer.files[0];
      if (file.type === "image/png") {
        readPromptFromPNG(file);
      } else {
        alert("Please drop a PNG file.");
      }
    }
  });

  // ====== ADD SELECTION TO SNIPPETS ======
  function addSelectionToSnippets() {
    let textarea = document.getElementById("imagePromptBox");
    let selected = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd).trim();
    if (selected.length > 0) {
      categories["Custom"].push(selected);
      buildTree(document.getElementById("searchBox").value);
    } else {
      alert("Please select part of the imported prompt first.");
    }
  }

  // ====== INIT ======
  buildTree();
  loadSlots();
  document.getElementById("searchBox").addEventListener("input", (e) => buildTree(e.target.value));
</script>
</body>
</html>
