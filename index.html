<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stable Diffusion Prompt Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .tree-category { cursor: pointer; font-weight: bold; }
    .tree-item { cursor: pointer; margin-left: 20px; display: block; }
    textarea { height: 150px; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Stable Diffusion Prompt Manager</h1>
  <div class="row">
    <!-- Prompt Area -->
    <div class="col-md-6">
      <h4>Prompt</h4>
      <textarea id="promptBox" class="form-control mb-2"></textarea>
      <div>
        <button class="btn btn-sm btn-secondary" onclick="toLowercase('promptBox')">Lowercase</button>
        <button class="btn btn-sm btn-secondary" onclick="dedupe('promptBox')">De-duplicate</button>
        <button class="btn btn-sm btn-secondary" onclick="formatPrompt('promptBox')">Format</button>
      </div>
    </div>
    <!-- Negative Prompt Area -->
    <div class="col-md-6">
      <h4>Negative Prompt</h4>
      <textarea id="negPromptBox" class="form-control mb-2"></textarea>
      <div>
        <button class="btn btn-sm btn-secondary" onclick="toLowercase('negPromptBox')">Lowercase</button>
        <button class="btn btn-sm btn-secondary" onclick="dedupe('negPromptBox')">De-duplicate</button>
        <button class="btn btn-sm btn-secondary" onclick="formatPrompt('negPromptBox')">Format</button>
      </div>
    </div>
  </div>

  <hr class="my-4">

  <!-- Tree View -->
  <h4>Prompt Builder</h4>
  <div id="treeView" class="mb-4"></div>
</div>

<script>
  // Sample categories (can be extended or loaded from JSON)
  const categories = {
    "Quality": ["high quality", "8k", "masterpiece", "ultra detailed"],
    "Styles": ["photorealistic portrait", "anime style", "cartoon", "oil painting"],
    "Effects": ["cinematic lighting", "soft focus", "hdr", "vivid colors"],
    "Negative": ["low quality", "blurry", "bad anatomy", "duplicate"]
  };

  // ====== TEXT AREA FUNCTIONS ======
  function getTokens(id) {
    return document.getElementById(id).value.split(",")
      .map(t => t.trim()).filter(t => t.length > 0);
  }

  function setTokens(id, tokens) {
    document.getElementById(id).value = tokens.join(", ");
  }

  function toLowercase(id) {
    let tokens = getTokens(id).map(t => t.toLowerCase());
    setTokens(id, tokens);
  }

  function dedupe(id) {
    let tokens = [...new Set(getTokens(id).map(t => t.toLowerCase()))];
    setTokens(id, tokens);
  }

  function formatPrompt(id) {
    let tokens = [...new Set(getTokens(id).map(t => t.toLowerCase()))];
    setTokens(id, tokens);
  }

  // ====== TREE VIEW BUILDER ======
  function buildTree() {
    const container = document.getElementById("treeView");
    container.innerHTML = "";

    for (let category in categories) {
      let catDiv = document.createElement("div");
      catDiv.className = "tree-category";
      catDiv.innerText = category;
      catDiv.onclick = () => {
        let next = catDiv.nextSibling;
        next.style.display = next.style.display === "none" ? "block" : "none";
      };
      container.appendChild(catDiv);

      let itemDiv = document.createElement("div");
      categories[category].forEach(snippet => {
        let item = document.createElement("span");
        item.className = "tree-item";
        item.innerText = snippet;
        item.onclick = () => insertSnippet(snippet, category);
        itemDiv.appendChild(item);
      });
      container.appendChild(itemDiv);
    }
  }

  function insertSnippet(snippet, category) {
    const boxId = (category === "Negative") ? "negPromptBox" : "promptBox";
    let tokens = getTokens(boxId);
    tokens.push(snippet);
    setTokens(boxId, tokens);
    formatPrompt(boxId);
  }

  // Init
  buildTree();
</script>
</body>
</html>
